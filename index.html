<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>成本毛利計算表（網頁版）</title>
  <style>
    :root{
      --border:#d9d9d9;
      --muted:#666;
      --bg:#fafafa;
      --card:#fff;
      --label:#FDE9D9;
      --hdr:#E4DFEC;
      --sell:#FFF2CC;
    }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
      margin: 20px auto;
      max-width: 980px;
      padding: 0 14px;
      line-height: 1.5;
      color:#111;
    }
    h1{font-size:20px;margin:0 0 12px}
    .layout{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:14px;
    }
    @media (max-width: 820px){
      .layout{grid-template-columns:1fr}
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
    }
    td, th{
      border:1px solid var(--border);
      padding:8px 10px;
      font-size:14px;
    }
    th{
      background:var(--hdr);
      text-align:center;
      font-weight:700;
    }
    .label{
      background:var(--label);
      font-weight:700;
      text-align:center;
      width:120px;
    }
    .sellCell{
      background:var(--sell);
      font-weight:700;
      color:#b00020;
    }
    input[type="text"], input[type="number"]{
      width:100%;
      box-sizing:border-box;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:14px;
    }
    .right{text-align:right}
    .center{text-align:center}
    .big{font-weight:800;font-size:16px}
    .neg{color:#b00020}
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    button{
      border:1px solid var(--border);
      background:var(--bg);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
    }
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>

<h1>成本毛利計算表（網頁版）</h1>

<div class="layout">
  <!-- 左側 -->
  <div class="card">
    <table>
      <tr>
        <td class="label">品名</td>
        <td colspan="2"><input id="productName" type="text" placeholder="例如：防滑椅腳襪"></td>
      </tr>
      <tr>
        <td class="label" style="color:#b00020;">賣價</td>
        <td colspan="2" class="sellCell">
          <input id="sell" type="number" step="0.01" placeholder="例如 590">
        </td>
      </tr>
      <tr>
        <td class="label">成本總計</td>
        <td colspan="2" class="right big"><span id="costTotal">0</span></td>
      </tr>
      <tr>
        <td class="label">銷售毛利率</td>
        <td colspan="2" class="right big"><span id="gpRate">—</span></td>
      </tr>
      <tr>
        <td class="label">毛利額</td>
        <td colspan="2" class="right big"><span id="gpAmt">—</span></td>
      </tr>
    </table>

    <br>

    <table>
      <tr>
        <th>材料品名</th>
        <th style="width:22%">單價</th>
        <th>備註</th>
      </tr>
      <tbody id="materials"></tbody>
    </table>

    <div class="actions">
      <button id="addRow">＋新增一列</button>
      <button id="clearAll">清空</button>
      <button id="exportExcel">匯出 Excel</button>
      <span class="muted" id="exportHint"></span>
    </div>

    <div class="muted">銷售毛利率 =（賣價 − 成本總計）÷ 賣價</div>
  </div>

  <!-- 右側倍率 -->
  <div class="card">
    <table>
      <tr>
        <th>倍率</th>
        <th>建議賣價</th>
        <th>銷售毛利率</th>
      </tr>
      <tbody id="multipliers"></tbody>
    </table>
  </div>
</div>

<!-- 匯出 Excel 用：SheetJS (xlsx) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  const $ = s => document.querySelector(s);
  const fmtMoney = v => (Math.round(v*100)/100).toLocaleString('zh-TW',{maximumFractionDigits:2});
  const fmtPct = v => (Math.round(v*10000)/100).toLocaleString('zh-TW',{maximumFractionDigits:2})+'%';
  const num = v => Number(v)||0;

  const state = { rows:10, mult:[1.4,1.5,1.6,1.7] };

  function buildMaterials(){
    const tb = $('#materials');
    tb.innerHTML = '';
    for(let i=0;i<state.rows;i++){
      tb.innerHTML += `
        <tr>
          <td><input class="m-name" placeholder="材料 ${i+1}"></td>
          <td><input type="number" step="0.01" class="price right" placeholder="0"></td>
          <td><input class="m-note" placeholder=""></td>
        </tr>`;
    }
    tb.querySelectorAll('input').forEach(i=>i.oninput=render);
  }

  function buildMult(){
    const tb = $('#multipliers');
    tb.innerHTML = '';
    state.mult.forEach(m=>{
      tb.innerHTML += `
        <tr>
          <td class="center"><input type="number" value="${m}" step="0.1" class="mult"></td>
          <td class="right suggest">0</td>
          <td class="right rate">—</td>
        </tr>`;
    });
    tb.querySelectorAll('.mult').forEach(i=>i.oninput=()=>{
      state.mult=[...tb.querySelectorAll('.mult')].map(x=>num(x.value));
      render();
    });
  }

  function getCost(){
    const prices = [...document.querySelectorAll('.price')].map(i=>num(i.value));
    return prices.reduce((a,b)=>a+b,0);
  }

  function render(){
    const sell = num($('#sell').value);
    const cost = getCost();
    const gp = sell - cost;
    const rate = sell>0 ? gp/sell : null;

    $('#costTotal').textContent = fmtMoney(cost);
    $('#gpAmt').textContent = (sell || cost) ? fmtMoney(gp) : '—';
    $('#gpAmt').classList.toggle('neg', gp<0);
    $('#gpRate').textContent = rate===null ? '—' : fmtPct(rate);

    document.querySelectorAll('#multipliers tr').forEach((tr,i)=>{
      const s = cost * (state.mult[i] || 0);
      tr.querySelector('.suggest').textContent = fmtMoney(s);
      tr.querySelector('.rate').textContent = s>0 ? fmtPct((s-cost)/s) : '—';
    });
  }

  $('#addRow').onclick = ()=>{ state.rows++; buildMaterials(); render(); };
  $('#clearAll').onclick = ()=>{
    if(confirm('確定清空？')){
      document.querySelectorAll('input').forEach(i=>i.value='');
      render();
    }
  };

  // ✅ 匯出 Excel
  function exportToExcel(){
    if (!window.XLSX){
      $('#exportHint').textContent = '（匯出元件載入失敗，請確認有網路）';
      return;
    }

    const name = ($('#productName').value || '未命名').trim();
    const sell = num($('#sell').value);
    const cost = getCost();
    const gp = sell - cost;
    const gpRate = sell>0 ? gp/sell : null;

    // 收材料明細
    const mats = [...document.querySelectorAll('#materials tr')].map(tr => ({
      mName: tr.querySelector('.m-name')?.value || '',
      mPrice: num(tr.querySelector('.price')?.value),
      mNote: tr.querySelector('.m-note')?.value || ''
    })).filter(r => r.mName || r.mPrice || r.mNote); // 只留有填的

    // 收倍率表
    const multRows = [...document.querySelectorAll('#multipliers tr')].map(tr => {
      const m = num(tr.querySelector('.mult')?.value);
      const suggest = cost * (m || 0);
      const rate = suggest>0 ? (suggest-cost)/suggest : null;
      return { m, suggest, rate };
    });

    // 用 AOA（二維陣列）組工作表
    const aoa = [];
    aoa.push(['品名', name]);
    aoa.push(['賣價', sell]);
    aoa.push(['成本總計', cost]);
    aoa.push(['銷售毛利率', gpRate===null ? '' : gpRate]);
    aoa.push(['毛利額', gp]);
    aoa.push([]);
    aoa.push(['倍率試算（成本×倍率=建議賣價）']);
    aoa.push(['倍率', '建議賣價', '銷售毛利率']);
    multRows.forEach(r => aoa.push([r.m, r.suggest, r.rate===null ? '' : r.rate]));
    aoa.push([]);
    aoa.push(['材料明細']);
    aoa.push(['材料品名', '單價', '備註']);
    mats.forEach(r => aoa.push([r.mName, r.mPrice, r.mNote]));

    const ws = XLSX.utils.aoa_to_sheet(aoa);

    // 設定數字格式（讓 Excel 看起來像表格）
    // B2 賣價、B3 成本、B5 毛利額等：金額
    // B4 銷售毛利率、倍率區毛利率：百分比
    const setFmt = (cell, fmt) => { if (ws[cell]) ws[cell].z = fmt; };

    setFmt('B2', '#,##0.00');
    setFmt('B3', '#,##0.00');
    setFmt('B5', '#,##0.00');
    setFmt('B4', '0.00%');

    // 倍率區：從第 8 行開始（倍率表頭在第 8 行）
    // 以 aoa 排列：第 8 行是 ['倍率','建議賣價','銷售毛利率']
    // 資料從第 9 行開始，C 欄是毛利率
    const multStartRow = 9;
    for (let i=0; i<multRows.length; i++){
      const row = multStartRow + i;
      setFmt(`B${row}`, '#,##0.00');
      setFmt(`C${row}`, '0.00%');
    }

    // 材料明細的單價也設金額（找出「材料明細」區塊開始列）
    // 我們用搜尋 aoa 裡的 '材料明細' 位置推算列
    const matTitleIdx = aoa.findIndex(r => r[0] === '材料明細');
    const matHeaderRow = matTitleIdx + 2; // +1 是 1-based；再 +1 跳過標題列
    const matDataStart = matHeaderRow + 1; // header下一列
    for (let i=0; i<mats.length; i++){
      const row = matDataStart + i;
      setFmt(`B${row}`, '#,##0.00');
    }

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '成本毛利');

    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    const filename = `${name}_成本毛利_${yyyy}-${mm}-${dd}.xlsx`;

    XLSX.writeFile(wb, filename);
    $('#exportHint').textContent = '（已下載）';
    setTimeout(()=>$('#exportHint').textContent='', 1500);
  }

  $('#exportExcel').onclick = exportToExcel;

  buildMaterials();
  buildMult();
  render();
</script>

</body>
</html>
